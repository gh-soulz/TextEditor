<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üìù text editor v6</title>
  <link rel="icon" type="image/x-icon" href="icon.png" />
  <style>
    @font-face {
      font-family: 'Playfair Display';
      src: url('fonts/PlayfairDisplay.ttf') format('truetype');
    }
    @font-face {
      font-family: 'Rubik';
      src: url('fonts/Rubik.ttf') format('truetype');
    }
    @font-face {
      font-family: 'Syne';
      src: url('fonts/Syne.ttf') format('truetype');
    }
    @font-face {
      font-family: 'Nunito';
      src: url('fonts/Nunito.ttf') format('truetype');
    }
    @font-face {
      font-family: 'Lora';
      src: url('fonts/Lora.ttf') format('truetype');
    }
    @font-face {
      font-family: 'Lexend';
      src: url('fonts/Lexend.ttf') format('truetype');
    }

    :root {
      --background-color: #111; /* Dark mode background */
      --text-color: white; /* Dark mode text color */
      --modal-background: #222; /* Dark mode modal background */
      --input-background: #333; /* Dark mode input background */
    }

    body.light-mode {
      --background-color: #f5f5f5; /* Light mode background */
      --text-color: #333; /* Light mode text color */
      --modal-background: #fff; /* Light mode modal background */
      --input-background: #eee; /* Light mode input background */
    }

    body {
      font-family: 'lexend';
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      background-color: var(--background-color);
      color: var(--text-color);
      user-select: none;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    textarea {
      width: 100%;
      font-family: inherit;
      max-width: 650px;
      height: 300px;
      min-height: 300px;
      max-height: 400px;
      resize: none;
      margin-bottom: 20px;
      padding: 10px;
      font-size: 16px;
      background-color: var(--modal-background);
      border: none;
      outline: none;
      border-radius: 7px;
      transition: background 0.2s ease;
      color: var(--text-color);
    }

    textarea:hover {
      background-color: var(--input-background);
    }

    .file-controls,
    .controls {
      font-family: inherit;
      display: flex;
      gap: 10px;
    }

    .file-controls {
      padding: 10px 0;
    }

    button,
    select {
      font-family: inherit;
      padding: 10px;
      font-size: 16px;
      border: none;
      outline: none;
      background-color: var(--modal-background);
      color: var(--text-color);
      border-radius: 7px;
      transition: background 0.2s ease;
      cursor: pointer;
    }

    button:hover,
    select:hover {
      background-color: var(--input-background);
    }

    .modal {
      display: flex;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      justify-content: center;
      align-items: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s ease;
    }

    .modal.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: var(--modal-background);
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      width: 100%;
      max-width: 400px;
      outline: none;
      font-family: inherit;
      color: var(--text-color);
    }

    .modal-content input {
      font-family: inherit;
      width: 94%;
      padding: 10px;
      margin-bottom: 20px;
      border: none;
      outline: none;
      border-radius: 5px;
      background-color: var(--input-background);
      color: var(--text-color);
    }

    .modal-content button {
      margin: 0 5px;
      font-family: inherit;
    }

    #styleSettingsModal .modal-content {
      padding: 30px;
    }

    #styleSettingsModal label {
      display: block;
      margin-bottom: 10px;
      font-size: 16px;
    }

    #styleSettingsModal input[type="color"],
    #styleSettingsModal select {
      width: 100%;
      padding: 10px;
      margin-bottom: 20px;
      border-radius: 5px;
      background-color: var(--input-background);
      color: var(--text-color);
      border: none;
      outline: none;
      font-family: inherit;
    }

    #styleSettingsModal .slider-container {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }

    #styleSettingsModal input[type="range"] {
      width: 80%;
      cursor: pointer;
    }

    #styleSettingsModal button {
      margin-top: 20px;
    }

    h1 {
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <h1>üìù text editor v6</h1>

  <!-- File selector + rename -->
  <div class="file-controls">
    <select id="fileSelector">
      <option value="" disabled selected>select file</option>
    </select>
    <button id="renameFile">‚úèÔ∏è</button>
    <button id="themeToggle">‚òÄÔ∏è</button> <!-- New theme toggle button -->
  </div>

  <!-- Main editor -->
  <textarea id="editor" placeholder="‚úçüèª start typing..."></textarea>

  <!-- Buttons row -->
  <div class="controls">
    <button id="download">üíæ</button>
    <button id="upload">üì§</button>
    <button id="newFile">‚ûï</button>
    <button id="deleteFile">üóëÔ∏è</button>
    <button id="updates" onclick="location.href='updates';">‚ÑπÔ∏è</button>
    <button id="fileMetadata">üìä</button>
    <button id="styleSettings">üé®</button>
  </div>

  <!-- Custom modal (renaming, confirmations, etc.) -->
  <div id="customModal" class="modal">
    <div class="modal-content">
      <p id="modalMessage"></p>
      <input id="modalInput" type="text" style="display: none;" />
      <div>
        <button id="modalConfirm">‚úÖ confirm</button>
        <button id="modalCancel">‚ùå cancel</button>
      </div>
    </div>
  </div>

  <!-- Metadata Modal -->
  <div id="metadataModal" class="modal">
    <div class="modal-content">
      <h2>üìä file metadata</h2>
      <p id="fileName"></p>
      <p id="fileCreated"></p>
      <p id="fileLastModified"></p>
      <p id="fileSize"></p>
      <p id="fileLetters"></p>
      <p id="fileWords"></p>
      <button id="closeMetadata">‚ùå close</button>
    </div>
  </div>

  <!-- Style Settings Modal -->
  <div id="styleSettingsModal" class="modal">
    <div class="modal-content">
      <h2>üé® style settings</h2>
      <label for="outlineColor">outline color:</label>
      <input type="color" id="outlineColor" value="#000000">
      <label for="outlineThickness">outline thickness:</label>
      <div class="slider-container">
        <input type="range" id="outlineThickness" min="0" max="4" step="1" value="0">
      </div>
      <label for="fontSelector">font:</label>
      <select id="fontSelector">
        <option value="Lexend">lexend</option>
        <option value="Playfair Display">playfair display</option>
        <option value="Rubik">rubik</option>
        <option value="Syne">syne</option>
        <option value="Nunito">nunito</option>
        <option value="Lora">lora</option>
      </select>
      <label for="presets">presets:</label>
      <select id="presets">
        <option value="default">default</option>
        <option value="sakura">sakura</option>
        <option value="purpleHaze">purple haze</option>
        <option value="azure">azure</option>
        <option value="celadon">celadon</option>
        <option value="carmine">carmine</option>
      </select>
      <button id="applyStyle">‚úÖ apply</button>
      <button id="closeStyleSettings">‚ùå close</button>
    </div>
  </div>

  <script>
    /* ---------------------------
       Main IndexedDB + Editor JS
    ----------------------------*/
    const editor = document.getElementById('editor');
    const downloadButton = document.getElementById('download');
    const uploadButton = document.getElementById('upload');
    const newFileButton = document.getElementById('newFile');
    const deleteFileButton = document.getElementById('deleteFile');
    const renameFileButton = document.getElementById('renameFile');
    const fileSelector = document.getElementById('fileSelector');
    const customModal = document.getElementById('customModal');
    const modalMessage = document.getElementById('modalMessage');
    const modalInput = document.getElementById('modalInput');
    const modalConfirm = document.getElementById('modalConfirm');
    const modalCancel = document.getElementById('modalCancel');
    const styleSettingsButton = document.getElementById('styleSettings');
    const styleSettingsModal = document.getElementById('styleSettingsModal');
    const outlineColor = document.getElementById('outlineColor');
    const outlineThickness = document.getElementById('outlineThickness');
    const fontSelector = document.getElementById('fontSelector');
    const presets = document.getElementById('presets');
    const applyStyleButton = document.getElementById('applyStyle');
    const closeStyleSettingsButton = document.getElementById('closeStyleSettings');
    const themeToggle = document.getElementById('themeToggle');

    let db;
    let currentFile = null;
    let modalCallback = null;

    // Theme Toggle Logic
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
      document.body.classList.add(savedTheme);
      themeToggle.textContent = savedTheme === 'light-mode' ? 'üåô' : 'üåû';
    }

    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('light-mode');
      const isLightMode = document.body.classList.contains('light-mode');
      themeToggle.textContent = isLightMode ? 'üåô' : 'üåû';
      localStorage.setItem('theme', isLightMode ? 'light-mode' : 'dark-mode');
    });

    function openModal(message, isInput = false, callback) {
      modalMessage.textContent = message;
      modalInput.style.display = isInput ? 'block' : 'none';
      modalInput.value = '';
      customModal.classList.add('active');
      modalCallback = callback;
    }

    function closeModal() {
      customModal.classList.remove('active');
      modalCallback = null;
    }

    modalConfirm.addEventListener('click', () => {
      if (modalCallback) {
        const inputValue =
          modalInput.style.display === 'block'
            ? modalInput.value.trim()
            : true;
        modalCallback(inputValue);
      }
      closeModal();
    });

    modalCancel.addEventListener('click', closeModal);

    function openDatabase() {
      const request = indexedDB.open('TextEditorDB', 1);

      request.onupgradeneeded = (event) => {
        db = event.target.result;
        if (!db.objectStoreNames.contains('files')) {
          db.createObjectStore('files', { keyPath: 'name' });
        }
      };

      request.onsuccess = (event) => {
        db = event.target.result;
        loadFileList();
      };

      request.onerror = (event) => {
        console.error('‚ö†Ô∏è database error:', event.target.error);
      };
    }

    /**
     * Save or update a file in IndexedDB.
     * - Preserves creation date if already present
     * - Always updates lastModified
     */
    function saveFileToDB(fileName, content) {
      const transaction = db.transaction('files', 'readwrite');
      const store = transaction.objectStore('files');
      const getRequest = store.get(fileName);

      getRequest.onsuccess = () => {
        // preserve creation timestamp if it exists
        let created;
        if (getRequest.result && getRequest.result.created) {
          created = getRequest.result.created;
        } else {
          created = new Date().toISOString();
        }

        // always update lastModified
        const lastModified = new Date().toISOString();

        store.put({ name: fileName, content, created, lastModified });
      };
    }

    function loadFileList() {
      const transaction = db.transaction('files', 'readonly');
      const store = transaction.objectStore('files');
      const request = store.getAll();

      request.onsuccess = () => {
        const files = request.result;
        fileSelector.innerHTML =
          '<option value="" disabled selected>select file</option>';
        files.forEach((file) => {
          const option = document.createElement('option');
          option.value = file.name;
          option.textContent = file.name;
          fileSelector.appendChild(option);
        });
      };
    }

    newFileButton.addEventListener('click', () => {
      openModal('‚Ü≥ enter new file name:', true, (fileName) => {
        if (!fileName) return;

        const transaction = db.transaction('files', 'readonly');
        const store = transaction.objectStore('files');
        const request = store.get(fileName);

        request.onsuccess = () => {
          if (request.result) {
            openModal(
              '‚ö†Ô∏è a file with this name already exists. please choose a different name'
            );
            return;
          }
          // Save new file (with creation timestamp)
          saveFileToDB(fileName, '');
          currentFile = fileName;
          editor.value = '';
          loadFileList();
        };
      });
    });

    deleteFileButton.addEventListener('click', () => {
      if (!currentFile) {
        openModal('‚ö†Ô∏è no file is currently selected.');
        return;
      }
      openModal(`‚ö†Ô∏è are you sure you want to delete '${currentFile}'?`, false, (confirm) => {
        if (confirm) {
          const transaction = db.transaction('files', 'readwrite');
          const store = transaction.objectStore('files');
          store.delete(currentFile);
          currentFile = null;
          editor.value = '';
          loadFileList();
        }
      });
    });

    // Preserve creation timestamp on rename
    renameFileButton.addEventListener('click', () => {
      if (!currentFile) {
        openModal('‚ö†Ô∏è no file is currently selected');
        return;
      }
      openModal('‚Ü≥ enter new name for the file:', true, (newFileName) => {
        if (!newFileName || newFileName === currentFile) return;

        const transaction = db.transaction('files', 'readwrite');
        const store = transaction.objectStore('files');
        // get the old file to preserve its created date
        const oldFileRequest = store.get(currentFile);

        oldFileRequest.onsuccess = () => {
          const oldFile = oldFileRequest.result;
          const created = oldFile ? oldFile.created : new Date().toISOString();
          const currentContent = editor.value;
          const lastModified = new Date().toISOString();

          // check if the new name already exists
          const getRequest = store.get(newFileName);
          getRequest.onsuccess = () => {
            if (getRequest.result) {
              openModal(
                '‚ö†Ô∏è a file with this name already exists. please choose a different name'
              );
              return;
            }
            // delete old file, then create the new one
            const deleteRequest = store.delete(currentFile);

            deleteRequest.onsuccess = () => {
              store.put({
                name: newFileName,
                content: currentContent,
                created,
                lastModified
              });
              currentFile = newFileName;
              loadFileList();
            };
          };
        };
      });
    });

    fileSelector.addEventListener('change', () => {
      const selectedFile = fileSelector.value;
      const transaction = db.transaction('files', 'readonly');
      const store = transaction.objectStore('files');
      const request = store.get(selectedFile);

      request.onsuccess = () => {
        const file = request.result;
        if (file) {
          currentFile = file.name;
          editor.value = file.content;
        }
      };
    });

    editor.addEventListener('input', () => {
      if (currentFile) {
        saveFileToDB(currentFile, editor.value);
      }
    });

    downloadButton.addEventListener('click', () => {
      if (!currentFile) {
        openModal('‚ö†Ô∏è no file is currently selected');
        return;
      }
      const blob = new Blob([editor.value], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = currentFile;
      link.click();
    });

    uploadButton.addEventListener('click', () => {
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.txt';

      fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const content = e.target.result;
            openModal('‚Ü≥ enter a name for the uploaded file:', true, (fileName) => {
              if (!fileName) return;
              saveFileToDB(fileName, content);
              currentFile = fileName;
              editor.value = content;
              loadFileList();
            });
          };
          reader.readAsText(file);
        }
      });
      fileInput.click();
    });

    openDatabase();

    /* -------------------------
       Style Settings Modal
    --------------------------*/
    styleSettingsButton.addEventListener('click', () => {
      styleSettingsModal.classList.add('active');
    });

    closeStyleSettingsButton.addEventListener('click', () => {
      styleSettingsModal.classList.remove('active');
    });

    applyStyleButton.addEventListener('click', () => {
      const color = outlineColor.value;
      const thickness = outlineThickness.value;
      const font = fontSelector.value;

      // Apply font to the entire page
      document.body.style.fontFamily = font;

      // Apply font to buttons, textarea, and select elements
      document.querySelectorAll('button, textarea, select, input, .modal-content').forEach(element => {
        element.style.fontFamily = font;
      });

      // Apply outline styles to buttons, textarea, and select elements
      document.querySelectorAll('button, textarea, select').forEach(element => {
        element.style.outlineColor = color;
        element.style.outlineWidth = `${thickness}px`;
        element.style.outlineStyle = thickness > 0 ? 'solid' : 'none'; // Hide outline if thickness is 0
      });

      // Apply outline styles to modal backgrounds
      document.querySelectorAll('.modal-content').forEach(modal => {
        modal.style.outlineColor = color;
        modal.style.outlineWidth = `${thickness}px`;
        modal.style.outlineStyle = thickness > 0 ? 'solid' : 'none';
      });

      styleSettingsModal.classList.remove('active');
    });

    presets.addEventListener('change', (event) => {
      const preset = event.target.value;
      if (preset === 'default') {
        outlineColor.value = '#000000';
        outlineThickness.value = 0; // No outline for default
        fontSelector.value = 'Lexend'; // Lexend font for default
      } else if (preset === 'sakura') {
        outlineColor.value = '#FFB7C5'; // Sakura color
        outlineThickness.value = 3;
        fontSelector.value = 'Playfair Display';
      } else if (preset === 'purpleHaze') {
        outlineColor.value = '#7D7098'; // Purple Haze color
        outlineThickness.value = 3;
        fontSelector.value = 'Rubik';
      } else if (preset === 'azure') {
        outlineColor.value = '#F0FFFF'; // Azure color
        outlineThickness.value = 3;
        fontSelector.value = 'Syne';
      } else if (preset === 'celadon') {
        outlineColor.value = '#AFE1AF'; // Celadon color
        outlineThickness.value = 3;
        fontSelector.value = 'Nunito';
      } else if (preset === 'carmine') {
        outlineColor.value = '#D70040'; // Carmine color
        outlineThickness.value = 3;
        fontSelector.value = 'Lora';
      }

      // Automatically apply the selected preset
      applyStyleButton.click();
    });
  </script>

  <script>
    /* -------------------------
       Locking/Unlocking Feature
    --------------------------*/
    const lockedFiles = {}; // Store lock states for each file
    const lockFileButton = document.createElement('button');
    lockFileButton.id = 'lockFile';
    lockFileButton.textContent = 'üîí';
    document.querySelector('.file-controls').appendChild(lockFileButton);

    lockFileButton.addEventListener('click', () => {
      if (!currentFile) {
        openModal('‚ö†Ô∏è no file is currently selected', false);
        return;
      }

      const fileLockState = lockedFiles[currentFile];

      if (fileLockState?.isLocked) {
        // Unlock flow
        openModal('‚Ü≥ enter password to unlock:', true, (password) => {
          if (password === fileLockState.password) {
            lockedFiles[currentFile] = { isLocked: false, password: null };
            editor.style.filter = 'none';
            editor.readOnly = false;
            lockFileButton.textContent = 'üîí';
            openModal('‚úÖ file unlocked successfully');
          } else {
            openModal('‚ö†Ô∏è incorrect password');
          }
        });
      } else {
        // Lock flow
        openModal('‚Ü≥ enter a password to lock the file:', true, (password) => {
          if (!password) {
            openModal('‚ö†Ô∏è Password cannot be empty.', false);
            return;
          }
          lockedFiles[currentFile] = { isLocked: true, password };
          editor.style.filter = 'blur(4px)';
          editor.readOnly = true;
          lockFileButton.textContent = 'üîì';
          openModal('‚úÖ file locked successfully');
        });
      }
    });

    // Prevent edits if file is locked
    editor.addEventListener('input', () => {
      const fileLockState = lockedFiles[currentFile];
      if (fileLockState?.isLocked) {
        openModal('‚ö†Ô∏è file is locked. please unlock to edit', false);
        editor.value = fileLockState.cachedContent || '';
      } else if (currentFile) {
        saveFileToDB(currentFile, editor.value);
        if (!lockedFiles[currentFile]) {
          lockedFiles[currentFile] = {};
        }
        lockedFiles[currentFile].cachedContent = editor.value;
      }
    });

    // Switch lock states on file change
    fileSelector.addEventListener('change', () => {
      const selectedFile = fileSelector.value;
      const transaction = db.transaction('files', 'readonly');
      const store = transaction.objectStore('files');
      const request = store.get(selectedFile);

      request.onsuccess = () => {
        const file = request.result;
        if (file) {
          currentFile = file.name;
          editor.value = file.content;
          const fileLockState = lockedFiles[currentFile];
          if (fileLockState?.isLocked) {
            editor.style.filter = 'blur(4px)';
            editor.readOnly = true;
            lockFileButton.textContent = 'üîì';
          } else {
            editor.style.filter = 'none';
            editor.readOnly = false;
            lockFileButton.textContent = 'üîí';
          }
        }
      };
    });
  </script>

  <script>
    /* ------------------------
       Metadata Modal Feature
    -------------------------*/
    const fileMetadataButton = document.getElementById('fileMetadata');
    const metadataModal = document.getElementById('metadataModal');
    const fileNameEl = document.getElementById('fileName');
    const fileCreated = document.getElementById('fileCreated');
    const fileLastModified = document.getElementById('fileLastModified');
    const fileSizeEl = document.getElementById('fileSize');
    const fileLetters = document.getElementById('fileLetters');
    const fileWords = document.getElementById('fileWords');
    const closeMetadataButton = document.getElementById('closeMetadata');

    fileMetadataButton.addEventListener('click', () => {
      if (!currentFile) {
        openModal('‚ö†Ô∏è no file is currently selected');
        return;
      }

      const transaction = db.transaction('files', 'readonly');
      const store = transaction.objectStore('files');
      const request = store.get(currentFile);

      request.onsuccess = () => {
        const file = request.result;
        if (file) {
          // File name
          fileNameEl.textContent = `file name: ${file.name}`;

          // Creation date
          fileCreated.textContent = `created: ${
            file.created
              ? new Date(file.created).toLocaleString()
              : 'not available'
          }`;

          // Last modified date
          fileLastModified.textContent = `last modified: ${
            file.lastModified
              ? new Date(file.lastModified).toLocaleString()
              : 'not available'
          }`;

          // File size in bytes (via Blob)
          const sizeInBytes = new Blob([file.content], {
            type: 'text/plain',
          }).size;
          fileSizeEl.textContent = `file size: ${sizeInBytes} bytes`;

          // Letters and words
          fileLetters.textContent = `letters: ${file.content.length}`;
          fileWords.textContent = `words: ${
            file.content.trim().split(/\s+/).filter(Boolean).length
          }`;

          metadataModal.classList.add('active');
        }
      };
    });

    closeMetadataButton.addEventListener('click', () => {
      metadataModal.classList.remove('active');
    });
  </script>
</body>
</html>
